{
    "AWSTemplateFormatVersion": "2019-09-09",
    "Description": "JSON string",
    "Metadata": {},
    "Parameters": {
        "InstanceTypeParameter": {
            "Name":"InstanceTypeParameter",
            "Description": "Enter t2.micro or t2.small default micro",
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": [
                "t2.micro",
                "t2.small"
            ]
        },
        "KeyPairParameter": {
            "Name":"KeyPairParameter",
            "Description": "Please supply an existing key pair",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "YourIP": {
            "Name":"YourIP",
            "Description": "Please select a public IP address in CIDR notation",
            "Type": "String",
            "Default": "0.0.0/0",
            "AllowedPattern": "^(\\d{1,3}\\.){3}\\d{1,3}\/\\d{1,2}$"
        }
    },
    "Resources": {
        "EngineeringVPC": {
            "Name":"EngineeringVPC",
            "CidrBlock": "10.0.0.0/18",
            "PublicSubnet1": {
                "Name":"PublicSubnet1",
                "Type": "AWS::EC2::Subnet",
                "Properties": {
                    "CidrBlock": "10.0.0.0/24",
                    "AvailabilityZone": "us-east-1"
                }
            },
            "PublicSubnet2": {
                "Name":"PublicSubnet2",
                "Type": "AWS::EC2::Subnet",
                "Properties": {
                    "CidrBlock": "10.0.1.0/24",
                    "AvailabilityZone": "us-east-2"
                }
            },
            "web1": {
                "Type": "AWS::EC2::Instance",
                "Name": "web1",
                "SubnetId": {
                    "Ref": "PublicSubnet1"
                },
                "InstanceType": {
                    "Ref": "InstanceTypeParameter"
                },
                "ImageId": "ami- 01cc34ab2709337aa",
                "KeyName": {
                    "Ref": "KeyPairParameter"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "#!/bin/bash",
                            "yum update -y",
                            "yum install -y git httpd php",
                            "service httpd start",
                            "chkconfig httpd on",
                            "aws s3 cp s3://seis665-public/index.php /var/www/html/"
                        ]
                    }
                }
            },
            "web2": {
                "Type": "AWS::EC2::Instance",
                "Name": "web2",
                "SubnetId": {
                    "Ref": "PublicSubnet2"
                },
                "InstanceType": {
                    "Ref": "InstanceTypeParameter"
                },
                "ImageId": "ami- 01cc34ab2709337aa",
                "KeyName": {
                    "Ref": "KeyPairParameter"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "#!/bin/bash",
                            "yum update -y",
                            "yum install -y git httpd php",
                            "service httpd start",
                            "chkconfig httpd on",
                            "aws s3 cp s3://seis665-public/index.php /var/www/html/"
                        ]
                    }
                }
            },
            "WebserversSG": {
                "Name":"WebserverSG",
                "Type": "AWS::EC2::SecurityGroup",
                "Properties": {
                    "SecurityGroupIngress": [
                        {
                            "FromPort": "22",
                            "CidrIP": {
                                "Ref": "YourIP"
                            }
                        },
                        {
                            "FromPort":"80",
                            "CidrIP":"0.0.0.0/0"
                        }
                    ]
                }
            }
        },
        "EngineeringLB":{
            "Name":"EngineeringLB",
            "Type":"AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties":{
                "Type":"application",
                "SecurityGroups":[
                    {
                        "Ref":"WebserversSg"
                    }
                ],
                "Subnets":[
                    {
                    "Ref":{"PublicSubnet1"}
                    },
                    {
                        "Ref":{"PublicSubnet2"}
                    }
                ]


            }
        },
        "EngineeringWebservers":{
            "Name":"EngineeringWebservers",
            "Protocol":"HTTP",
            "Port":80,
            "TargetType":"ip",
            "VpcId":{"Ref":"EngineeringVPC"}

        },
        "Listener":{
            "Name":"Listener",
            "Type":"AWS::ElasticLoadBalancingV2::Listener",
            "Properties":{
                "LoadBalancerArn":{"Ref":"EngineeringLB"},
                "Protocol":"HTTP",
                "Port":80,
                "DefaultActions": [
                    {
                        "Type":"forward",
                        "TargetGroupArn":{"Ref":"EngineeringWebservers"}
                    }
                ]

            }
        }
    },
    "Outputs": {}
}